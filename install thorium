# Thorium Browser installieren
if [[ "${ADDITIONAL_PACKAGES}" == *"thorium"* ]] || [ "${INSTALL_DESKTOP}" = "1" ]; then
    echo "Installiere Thorium Browser..."
    
    # CPU-Erweiterungen prüfen
    echo "Prüfe CPU-Erweiterungen..."
    if grep -q " avx2 " /proc/cpuinfo; then
        CPU_EXT="AVX2"
        echo "AVX2-Unterstützung gefunden."
    elif grep -q " avx " /proc/cpuinfo; then
        CPU_EXT="AVX"
        echo "AVX-Unterstützung gefunden."
    elif grep -q " sse4_1 " /proc/cpuinfo; then
        CPU_EXT="SSE4"
        echo "SSE4-Unterstützung gefunden."
    else
        CPU_EXT="SSE3"
        echo "Verwende SSE3-Basisversion."
    fi
    
    # Neueste Thorium-Version ermitteln
    THORIUM_VERSION=$(curl -s https://api.github.com/repos/Alex313031/Thorium/releases/latest | grep -Po '"tag_name": "M\K[^"]*')
    
    if [ -n "$THORIUM_VERSION" ]; then
        echo "Neueste Thorium-Version: $THORIUM_VERSION"
        THORIUM_URL="https://github.com/Alex313031/Thorium/releases/download/M${THORIUM_VERSION}/thorium-browser_${THORIUM_VERSION}_${CPU_EXT}.deb"
        
        echo "Lade Thorium herunter: $THORIUM_URL"
        if wget -O /tmp/thorium.deb "$THORIUM_URL"; then
            echo "Download erfolgreich, installiere Thorium..."
            apt-get install -y /tmp/thorium.deb
            rm /tmp/thorium.deb
        else
            echo "Download fehlgeschlagen, versuche generische Version..."
            # Versuche generische Version ohne CPU-Erweiterung
            THORIUM_URL="https://github.com/Alex313031/Thorium/releases/download/M${THORIUM_VERSION}/thorium-browser_${THORIUM_VERSION}_amd64.deb"
            if wget -O /tmp/thorium.deb "$THORIUM_URL"; then
                echo "Download erfolgreich, installiere generische Thorium-Version..."
                apt-get install -y /tmp/thorium.deb
                rm /tmp/thorium.deb
            else
                echo "Konnte Thorium nicht herunterladen, Installation übersprungen."
            fi
        fi
    else
        echo "Konnte Thorium-Version nicht ermitteln, Installation übersprungen."
    fi
fi